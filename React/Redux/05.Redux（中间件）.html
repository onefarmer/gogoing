<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
<script>
    // 状态管理器
    const createStore = function(reducer,initState,rewriteCreateStoreFunc){

        if (rewriteCreateStoreFunc) {
            // 改写管理器
            const newCreateStore = rewriteCreateStoreFunc(createStore);
            return newCreateStore(reducer, initState);
        }       
        let state = initState; // 初始状态  
        let listeners = []; // 订阅者
        /* 订阅 */
        function subscribe(listener){
            listeners.push(listener)
        }
        // 状态派发
        function dispatch(action) {    
            state = reducer(state, action); /* 按照我的计划修改 state*/
            // 订阅者读取数据
            for (let i = 0; i < listeners.length; i++) {
                const listener = listeners[i];
                listener();
            }
        }
        // 读取状态
        function getState(){
            return state;
        }
        /* 注意！！！只修改了这里，用一个不匹配任何计划的 type，来获取初始值 */
        dispatch({ type: Symbol() })
        return {
            subscribe,
            dispatch,
            getState
        }
    }    
    // 初始状态
    let initState = {   
            count: 0     
    }
    // 合并----------------------------------------------------------
    const reducer = combineReducers({
        counter: counterReducer
    });

    const store = createStore(reducer);
    const next = store.dispatch; // 修改之前的的派发器

    /* 重写了store.dispatch */
    store.dispatch = (action) => {
        console.log('this state', store.getState());
        console.log('action', action);
        next(action);
        console.log('next state', store.getState());
    }

    // 状态修改
    store.dispatch({
        type: 'INCREMENT'
    });    

    /*counterReducer, 一个子reducer*/
    /*注意：counterReducer 接收的 state 是 state.counter*/
    function counterReducer(state, action) {
    /*注意：如果 state 没有初始值，那就给他初始值！！*/  
        if (!state) {
            state = initState;
        }
        switch (action.type) {
            case 'INCREMENT':
            return {
                ...state,
                count: state.count + 1
            }
            case 'DECREMENT':
            return {
                ...state,
                count: state.count - 1
            }
            default:
            return state;
        }
    }
    //  接收reducer传入的reducers结合的函数
    function combineReducers(reducers) {
        const reducerKeys = Object.keys(reducers)
        /* 返回合并后的新的reducer函数 */
        return function combination(state = {}, action) { 
            /*生成的新的state*/
            const nextState = {}
            for (let i = 0; i < reducerKeys.length; i++) {
                // Key
                const key = reducerKeys[i];
                const reducer = reducers[key];      
                const previousStateForKey = state[key];
                const nextStateForKey = reducer(previousStateForKey, action)
                nextState[key] = nextStateForKey
            }
            return nextState;
        }
    }   
</script>
</body>
</html>